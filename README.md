# sf-crime-mapper

A full-stack interactive web app that forecasts San Francisco neighborhood-level incident risk and visualizes it on a Mapbox choropleth, built using FastAPI + Prophet + XGBoost + React (Vite).

**Live Demo: https://sf-crime-mapper-frontend.netlify.app/**


_Note on Loading Time_
```text
Because the web app is hosted on a free render service, it automatically goes to sleep after periods of
inactivity. If you visit the app after it has been idle, the first request can take up to 30 seconds to
respond while the server wakes up. Subsequent requests will be much faster.
```

Frontend: https://sf-crime-mapper-frontend.netlify.app/

Backend: https://sf-crime-mapper-api.onrender.com

---

**Features**
- Interactive Mapbox choropleth of SF neighborhoods
  - Hover for name, predicted mean incidents, and 0–100 risk
  - Legend and selected-boundary highlight
- Forecast mode (Prophet) — pick a date to see predicted incidents / risk
- Spike Risk mode (XGBoost) — probability that a week is an unusual “spike” for each neighborhood
- Filter controls wired through the API:
  - Crime Type: All / Violent / Property
  - Time of Day: All / Day / Night
- Robust API client with timeout + retry and clear error messaging
- Caching on the server so only the first forecast after wake-up is heavy


---

**Dataset**

The project uses the SFPD incidents export and aggregates to weekly neighborhood counts.
- Place your raw CSV at: `backend/app/data/raw/sfpd_incidents.csv` (gitignored)
- Run the prep script (below) to produce:
  - `backend/app/data/processed/counts_weekly.csv` – weekly counts per neighborhood
- Neighborhood polygons: `backend/app/data/neighborhoods.geojson`
What the prep script does
- Parses raw incidents → stamps to week starts (Mondays)
- Joins to analysis neighborhoods
- Computes weekly counts (+ simple dims: crime_type, time_of_day)

---

**Project Structure**
```text
sf-crime-mapper/
├── backend/
│   ├── requirements.txt                     # FastAPI, Prophet, XGBoost, scikit-learn, etc.
│   └── app/
│       ├── main.py                          # FastAPI routes (/api/health, /api/neighborhoods, /api/predict, /api/spike)
│       ├── ml_baseline.py                   # Prophet forecast helpers + simple caching
│       ├── predict_service.py               # (legacy/aux) prediction helpers if you keep both
│       ├── predict_spike_service.py         # XGBoost spike-risk service (loads models, builds features)
│       ├── data/
│       │   ├── neighborhoods.geojson        # analysis polygons (used by frontend & API)
│       │   ├── raw/
│       │   │   └── sfpd_incidents.csv       # raw SFPD export (gitignored)
│       │   └── processed/
│       │       └── counts_weekly.csv        # aggregated weekly counts generated by ml/prepare_data.py
│       └── models/
│           └── xgb_spike/                   # trained per-neighborhood spike models
│               ├── meta.json                # feature list, lag count, last training week
│               └── *.json                   # XGBoost model files (one per neighborhood)
│
├── frontend/
│   ├── index.html                           # Vite entry HTML
│   ├── vite.config.js                       # dev proxy /api -> :8000, build config
│   ├── netlify.toml                         # Netlify build/publish settings
│   ├── package.json                         # frontend deps & scripts
│   ├── package-lock.json
│   ├── .env                                 # VITE_MAPBOX_TOKEN, VITE_API_BASE (prod)
│   ├── public/                              # static assets (if any)
│   ├── dist/                                # production build output
│   └── src/
│       ├── api.js                           # fetch helpers with timeout/retry
│       ├── App.jsx                          # Map UI, controls, choropleth painting
│       ├── App.css                          # component styles
│       ├── index.css                        # global styles
│       ├── main.jsx                         # React bootstrap
│       └── assets/                          # images/icons/etc.
│
├── ml/
│   ├── prepare_data.py                      # builds processed/counts_weekly.csv from raw SFPD CSV
│   ├── train_prophet.py                     # (optional) training/serialization utilities for Prophet
│   ├── train_xgb_spike.py                   # trains per-neighborhood spike classifiers → models/xgb_spike
│   └── compute_segment_factors.py           # (optional) helper for engineered features
│
├── .gitignore                               # ignores raw data, models, venv, build artifacts
└── README.md                                # top-level project readme (what recruiters will read)
```

---

**How to Run Locally**

1. Clone the repository:
```text
git clone https://github.com/jacobhorne-jth/sf-crime-mapper.git
cd sf-crime-mapper
```
2. Create and activate a virtual environment for the backend
```text
cd backend
python -m venv .venv
# macOS/Linux
source .venv/bin/activate
# Windows (PowerShell)
# .venv\Scripts\Activate.ps1
```
3. Install backend dependencies
```text
pip install -r requirements.txt
```
4. Prepare data (from the repo root)
```text
# ensure raw CSV is at backend/app/data/raw/sfpd_incidents.csv
python ml/prepare_data.py
# this writes backend/app/data/processed/counts_weekly.csv
```
5. Run the API
```text
uvicorn app.main:app --app-dir backend --reload --port 8000
# API at http://localhost:8000
# Health check: http://localhost:8000/api/health
```
6. Install frontend and set Mapbox token
```text
cd ../frontend
npm install
cp .env.example .env
# edit .env and set:
# VITE_MAPBOX_TOKEN=pk.your_mapbox_token
# (leave VITE_API_BASE empty for local dev; Vite proxies /api to :8000)
```
7. Run the frontend
```text
npm run dev
# open http://localhost:5173
```


---

**Deployment**

_Backend: Render_

- Build command: `pip install -r backend/requirements.txt`

- Start command: `uvicorn app.main:app --host 0.0.0.0 --port $PORT --app-dir backend`

- Environment variables:

  - `PYTHON_VERSION=3.10.13`

- Notes: first request after idle is slow; the app caches forecasts.

_Frontend: Netlify_

- Base directory: `frontend/`

- Build command: `npm run build`

- Publish directory: `frontend/dist`

- Environment variables:

  - `VITE_MAPBOX_TOKEN=pk.your_mapbox_token`

  - `VITE_API_BASE=https://YOUR-RENDER-SERVICE.onrender.com`
(ensures the built site calls your hosted API)


---


**Example Workflow**

1. Open the app and choose Mode:

  - Forecast (Prophet): pick any date to see mean incidents + normalized risk per neighborhood.

  - Spike Risk (XGBoost): see probability that the week is an unusual spike.

2. Optionally set Crime Type and Time of Day (filters are carried end-to-end).

3. Hover a neighborhood to view:

  - Name

  - Risk (0–100)

  - Mean incidents (Forecast) or Spike probability (Spike mode)

4. Use the legend to quickly interpret high/low risk areas.

---

**Modeling Details**

- _Prophet Forecasts_

Trained on `counts_weekly.csv` per neighborhood with weekly seasonality; the API returns mean incidents and a min–max normalized risk (0–100) for the choropleth.

- _XGBoost Spike Risk_
  
Per-neighborhood classifier trained to detect unusual weeks using lag features (k=1…N), moving averages (4/8), yearly seasonality encodings (sin/cos), and a simple trend index. Models are loaded from `backend/app/models/xgb_spike/`.
Endpoint: `GET /api/spike?date=YYYY-MM-DD` → `{ served_week, predictions:[{ neighborhood_id, prob, risk }] }`.


---

**Example**


---

**License**

This project is licensed under the MIT License.

**Acknowledgments**
- San Francisco Police Department Open Data
- Mapbox GL JS
- Prophet, XGBoost, FastAPI, Vite, React
